name: helm chart workflow

on:
  workflow_call:
    inputs:
      action:
        description: ''
        required: true
        type: string
      context:
        description: ''
        required: false
        type: string
      chartmuseum_url:
        description: ''
        required: false
        type: string
      gh_pages_owner:
        description: ''
        required: false
        default: ${{ github.repository_owner }}
        type: string
      gh_pages_repository:
        description: ''
        required: false
        default: ${{ github.event.repository.name }}
        type: string
      charts_folder:
        description: ''
        required: false
        default: ./charts
        type: string
    secrets:
      CHARTMUSEUM_USERNAME:
        description: ''
        required: false
      CHARTMUSEUM_PASSWORD:
        description: ''
        required: false

jobs:
  helm-chart-workflow:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - run: env | sort
      - run: cat ${GITHUB_EVENT_PATH}
      - uses: ptonini-actions/config-git-user@v1
      - uses: helm/chart-testing-action@v2
      - uses: helm/chart-releaser-action@v1
        with:
          install_only: true
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # Generate context variables ############################################
      - if: inputs.context
        name: generate context variables
        run: |
          echo "CHART=$(helm show chart ${{ inputs.context }} | sed -rn 's/^name: (.*)$/\1/p')" | tee -a $GITHUB_ENV
          echo "VERSION=$(helm show chart ${{ inputs.context }} | sed -rn 's/^version: (.*)$/\1/p')" | tee -a $GITHUB_ENV

      # Test helm chart #######################################################
      - if: inputs.action == 'test'
        uses: helm/kind-action@v1

      - if: inputs.action == 'test'
        run: ct install --chart-dirs ${{ inputs.context }}

      # Build helm chart ######################################################
      - if: inputs.action == 'build'
        name: build helm package
        run: |  
          helm package --dependency-update ${{ inputs.context }}
          gh release upload --clobber ${CHART}-v${VERSION} ${CHART}-${VERSION}.tgz
      - if: inputs.action == 'build'
        uses: actions/upload-artifact@v6
        with:
          name: ${{ format('{0}-{1}.tgz', env.CHART, env.VERSION) }}
          path: ${{ format('{0}-{1}.tgz', env.CHART, env.VERSION) }}

      # Publish helm chart ####################################################
      - if: inputs.action == 'publish'
        uses: actions/download-artifact@v7
        with:
          path: ${{ github.workspace }}/builds
          merge-multiple: true

      ### Publish to Chartmuseum ##########################
      - if: inputs.action == 'publish' && inputs.chartmuseum_url
        run: find ${{ github.workspace }}/builds -iname '*.tgz' -type f -exec curl -u "${{ secrets.CHARTMUSEUM_USERNAME }}:${{ secrets.CHARTMUSEUM_PASSWORD }}" --data-binary "@{}" ${{ inputs.chartmuseum_url }}/api/charts

      #### Update GitHup Pages repository #################
      - if: inputs.action == 'publish' && !inputs.chartmuseum_url
        run: cr index -p "${{ github.workspace }}/builds" -i index.yaml -o ${{ inputs.gh_pages_owner }} -t ${{ env.GH_TOKEN && env.GH_TOKEN || github.token }} -r ${{ inputs.gh_pages_repository }} --push --release-name-template "{{ .Name }}-v{{ .Version }}"

      # Update dependencies in related charts #################################
      - if: inputs.action == 'update dependencies'
        name: update dependencies
        run: |
          pip3 install yq
          for C in $(find {{ inputs.charts_folder }} -name "Chart.yaml"); do
            echo "reading ${C}"
            yq --arg chart ${CHART} --arg version ${VERSION} -yi '(try .dependencies[] | select(.name==$chart).version) |= $version' ${C}
          done
          if [[ $(git diff --name-only | wc -l) != 0 ]]; then
            export BRANCH=dependency-update/${CHART}-v${VERSION}
            git checkout -b ${BRANCH}
            echo "----- updated charts -----"
            git diff --name-only
            echo "--------------------------"
            git add .
            git commit -m "deps: updated dependency ${CHART} to ${VERSION}"
            git push origin -u ${BRANCH}
            gh pr create --fill --no-maintainer-edit
          fi