name: helm chart handler

on:
  workflow_call:
    inputs:
      action:
        description: ''
        required: true
        type: string
      context:
        description: ''
        required: false
        type: string
      chartmuseum_url:
        description: ''
        required: false
        type: string
      gh_pages_owner:
        description: ''
        required: false
        default: ${{ github.repository_owner }}
        type: string
      gh_pages_repository:
        description: ''
        required: false
        gh_pages_repository: ${{ github.event.repository.name }}
        type: string
    secrets:
      CHARTMUSEUM_USERNAME:
        description: ''
        required: false
      CHARTMUSEUM_PASSWORD:
        description: ''
        required: false

jobs:
  handler:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - run: env | sort
      - run: cat ${GITHUB_EVENT_PATH}
      - uses: ptonini-actions/config-git-user@v1
      - uses: helm/chart-releaser-action@v1
        with:
          install_only: true
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0



      # Generate context variables ############################################
      - if: inputs.context != ''
        name: generate context variables
        run: |
          echo "CHART=$(helm show chart ${{ inputs.context }} | sed -rn 's/^name: (.*)$/\1/p')" | tee -a $GITHUB_ENV
          echo "VERSION=$(helm show chart ${{ inputs.context }} | sed -rn 's/^version: (.*)$/\1/p')" | tee -a $GITHUB_ENV

      # Build helm package ####################################################
      - if: inputs.action == 'build'
        name: build & publish helm package
        run: |  
          helm package --dependency-update ${{ inputs.context }}
          gh release upload --clobber ${CHART}-v${VERSION} ${CHART}-v${VERSION} ${CHART}-v${VERSION}.tgz
      - if: inputs.action == 'build'
        uses: actions/upload-artifact@v6
        with:
          path: ${{ format('{0}-v{1}.tgz', env.CHART, env.VERSION) }}

      # Publish helm package ##################################################
      - if: inputs.action == 'publish'
        uses: actions/download-artifact@v7
        with:
          path: ${{ github.workspace }}/builds

      ### Publish to Chartmuseum ##########################
      - if: inputs.action == 'publish' && inputs.chartmuseum_url != ''
        run: curl -u "${{ secrets.CHARTMUSEUM_USERNAME }}:${{ secrets.CHARTMUSEUM_PASSWORD }}" --data-binary ${{ github.workspace }}/builds/"@${CHART}-${VERSION}.tgz" ${{ inputs.chartmuseum_url }}/api/charts

      #### Update GitHup Pages repository #################
      - if: inputs.action == 'publish' &&&& inputs.chartmuseum_url == ''
        run: cr index -p builds -i index.yaml -o ${{ inputs.gh_pages_owner }} -t ${{ env.GH_TOKEN && env.GH_TOKEN || github.token }} -r ${{ inputs.gh_pages_repository }} --push --release-name-template "{{ .Name }}-v{{ .Version }}"

      # Update dependencies in related charts #################################
      - if: inputs.action == 'update dependencies'
        name: update dependencies
        run: |
          pip3 install yq
          export BRANCH=dependency-update/${CHART}-v${VERSION}
          for C in $(find ./charts -name "Chart.yaml"); do
            echo "reading ${C}"
            yq --arg chart ${CHART} --arg version ${VERSION} -yi '(try .dependencies[] | select(.name==$chart).version) |= $version' ${C}
          done
          if [[ $(git diff --name-only | wc -l) != 0 ]]; then
            git checkout -b ${BRANCH}
            echo "----- updated charts -----"
            git diff --name-only
            echo "--------------------------"
            git add .
            git commit -m "deps: updated dependency ${CHART} to ${VERSION}"
            git push origin -u ${BRANCH}
            gh pr create --fill --no-maintainer-edit
          fi